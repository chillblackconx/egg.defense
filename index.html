<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    let system = { money: 500, health: 100, isModded: false, style: "default", active: false, gameOver: false };
    let cam = { x: 0, y: 0, drag: false, lx: 0, ly: 0 };
    let buildings = [], units = [], enemies = [], frame = 0;
    let placeType = null;
    const GRID = 50;

    // --- GESTION LOCALE STORAGE ---
    function saveToStorage() {
        if(system.gameOver) return; // Ne pas sauvegarder si on est mort
        const data = {
            money: system.money,
            health: system.health,
            buildings: buildings,
            modCode: document.getElementById('mod-code').value
        };
        localStorage.setItem('200ok_engine_save', JSON.stringify(data));
    }

    function checkSave() {
        if(localStorage.getItem('200ok_engine_save')) {
            document.getElementById('resume-btn').style.display = 'block';
        }
    }

    function clearSave() {
        localStorage.removeItem('200ok_engine_save');
        location.reload();
    }

    function launchGame(resume) {
        if(resume) {
            const data = JSON.parse(localStorage.getItem('200ok_engine_save'));
            system.money = data.money;
            system.health = data.health;
            buildings = data.buildings;
            document.getElementById('mod-code').value = data.modCode;
            try { eval(data.modCode); system.isModded = true; } catch(e){}
        }
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        document.getElementById('dock').style.display = 'flex';
        system.active = true;
        system.gameOver = false;
        loop();
    }

    // --- ACTIONS ---
    function toggleConsole() { const c = document.getElementById('console'); c.style.display = c.style.display==='block'?'none':'block'; }
    function activatePlacement(type) { placeType = type; document.getElementById('placement-hint').style.display = 'block'; }
    function applyMod() { try { eval(document.getElementById('mod-code').value); system.isModded = true; saveToStorage(); toggleConsole(); } catch(e){ alert(e); } }

    canvas.addEventListener('mousedown', (e) => {
        if(system.gameOver) return;
        if(placeType) {
            let cost = placeType === 'nuke_launcher' ? 200 : (placeType==='house'?20:10);
            if(system.money >= cost) {
                let gx = Math.round((e.clientX - canvas.width/2 - cam.x) / GRID) * GRID;
                let gy = Math.round((e.clientY - canvas.height/2 - cam.y) / GRID) * GRID;
                buildings.push({type: placeType, x: gx, y: gy});
                system.money -= cost;
                saveToStorage();
            }
            placeType = null; document.getElementById('placement-hint').style.display = 'none';
        } else { cam.drag = true; cam.lx = e.clientX; cam.ly = e.clientY; }
    });

    window.addEventListener('mouseup', () => cam.drag = false);
    window.addEventListener('mousemove', (e) => { if(cam.drag) { cam.x += e.clientX-cam.lx; cam.y += e.clientY-cam.ly; cam.lx=e.clientX; cam.ly=e.clientY; } });

    function spawnUnit(t) { if(system.money>=5){ system.money-=5; units.push({x:-cam.x, y:-cam.y, type:t}); } }

    // --- BOUCLE PRINCIPALE ---
    function loop() {
        if(!system.active || system.gameOver) return;
        
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
        frame++;

        // Sécurité Santé (Anti-Négatif)
        if(system.health <= 0) {
            system.health = 0;
            system.gameOver = true;
            showGameOver();
            return;
        }

        if(frame % 200 === 0) saveToStorage();
        if(frame % 150 === 0) enemies.push({x: Math.random()*2000-1000, y: -1000, hp: 50});
        
        document.getElementById('m-val').innerText = system.money;
        document.getElementById('h-val').innerText = Math.max(0, Math.ceil(system.health));

        let cx = canvas.width/2 + cam.x, cy = canvas.height/2 + cam.y;

        buildings.forEach(b => {
            ctx.fillStyle = b.type==='house'?'#2c3e50':(b.type==='wall'?'#7f8c8d':'#c0392b');
            ctx.fillRect(b.x+cx-20, b.y+cy-20, 40, 40);
            if(b.type === 'nuke_launcher' && frame % 200 === 0 && enemies.length > 0) enemies = [];
        });

        units.forEach(u => {
            let target = enemies[0];
            if(target) {
                let dx = target.x - u.x, dy = target.y - u.y, d = Math.sqrt(dx*dx+dy*dy);
                u.x += dx/d * 2; u.y += dy/d * 2;
                if(d < 50) target.hp -= 1;
            }
            ctx.fillStyle="white"; ctx.beginPath(); ctx.arc(u.x+cx, u.y+cy, 10, 0, 7); ctx.fill();
        });

        enemies.forEach(e => {
            let dx = -e.x, dy = -e.y, d = Math.sqrt(dx*dx+dy*dy);
            e.x += dx/d * 1.5; e.y += dy/d * 1.5;
            ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(e.x+cx, e.y+cy, 12, 0, 7); ctx.fill();
            if(d < 50) system.health -= 0.2; // Dégâts aux bâtiments/ville
        });

        enemies = enemies.filter(e => e.hp > 0);
        requestAnimationFrame(loop);
    }

    function showGameOver() {
        // Création dynamique de l'écran de mort s'il n'existe pas
        let screen = document.createElement('div');
        screen.style = "position:fixed; inset:0; background:rgba(200,0,0,0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:20000; color:white; font-family:sans-serif;";
        screen.innerHTML = `
            <h1 style="font-size:4em;">TERMINÉ</h1>
            <p>Votre ville a été rasée.</p>
            <button class="btn" style="padding:20px 40px; background:white; color:red;" onclick="clearSave()">RECOMMENCER</button>
        `;
        document.body.appendChild(screen);
    }

    checkSave();
</script>
