<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Studio 200ok - V14 Egg Strike</title>
    <style>
        :root { --accent: #00d2ff; --bg: #05070a; --panel: rgba(10, 15, 25, 0.95); }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        #ui-layer button { pointer-events: auto; }
        
        #main-menu { position: fixed; inset: 0; background: #05070a; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        #hud { position: absolute; top: 20px; left: 20px; display: none; }
        .card { background: var(--panel); border: 1px solid var(--accent); padding: 12px; border-radius: 8px; margin-bottom: 5px; font-weight: bold; }
        
        #dock { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--panel); padding: 10px; border-radius: 15px; display: none; gap: 10px; border: 1px solid #333[...]
        .btn { background: #1a202c; color: white; border: 1px solid #444; padding: 10px 15px; border-radius: 10px; cursor: pointer; text-align: center; }
        .btn:hover { border-color: var(--accent); background: #2d3748; }
        .btn span { display: block; font-size: 10px; color: var(--accent); }

        canvas { display: block; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="main-menu">
        <h1 style="color:var(--accent); letter-spacing:8px;">STUDIO 200ok</h1>
        <button class="btn" style="padding:15px 40px;" onclick="startGame(false)">NOUVELLE PARTIE</button>
        <button id="resume-btn" class="btn" style="display:none; padding:15px 40px; margin-top:10px; background:var(--accent); color:black;" onclick="startGame(true)">CONTINUER</button>
    </div>

    <div id="hud">
        <div class="card">üí∞ CASH: <span id="m-val">500</span>$</div>
        <div class="card">üõ°Ô∏è CITY LIFE: <span id="h-val">100</span>%</div>
    </div>

    <div id="dock">
        <button class="btn" onclick="setPlace('house')">üèôÔ∏è MAISON<span>20$</span></button>
        <button class="btn" onclick="setPlace('wall')">üöß MUR<span>10$</span></button>
        <button class="btn" onclick="setPlace('nuke_launcher')">‚ò¢Ô∏è NUKE<span>200$</span></button>
        <button class="btn" onclick="spawnEgg()">ü•ö EGG STRIKE<span>5$</span></button>
        <button class="btn" style="background:#c0392b" onclick="localStorage.clear(); location.reload();">üóëÔ∏è RESET</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    let system = { money: 500, health: 100, active: false, placeType: null };
    let cam = { x: 0, y: 0, drag: false, lx: 0, ly: 0 };
    let buildings = [], units = [], enemies = [], frame = 0;
    const GRID = 50;

    if(localStorage.getItem('save_v14')) document.getElementById('resume-btn').style.display = 'block';

    function startGame(resume) {
        if(resume) {
            const data = JSON.parse(localStorage.getItem('save_v14'));
            system.money = data.money; system.health = data.health; buildings = data.buildings;
        }
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        document.getElementById('dock').style.display = 'flex';
        system.active = true; animate();
    }

    function setPlace(t) { system.placeType = t; }
    
    function spawnEgg() { 
        if(system.money >= 5) { 
            system.money -= 5; 
            units.push({x: 0, y: 0, exploded: false}); 
        } 
    }

    canvas.addEventListener('mousedown', (e) => {
        if(!system.active) return;
        if(system.placeType) {
            let gx = Math.round((e.clientX - canvas.width/2 - cam.x) / GRID) * GRID;
            let gy = Math.round((e.clientY - canvas.height/2 - cam.y) / GRID) * GRID;
            buildings.push({type: system.placeType, x: gx, y: gy, hp: 100});
            system.money -= (system.placeType === 'nuke_launcher' ? 200 : (system.placeType === 'house' ? 20 : 10));
            system.placeType = null;
            save();
        } else { cam.drag = true; cam.lx = e.clientX; cam.ly = e.clientY; }
    });

    window.addEventListener('mouseup', () => cam.drag = false);
    window.addEventListener('mousemove', (e) => { if(cam.drag) { cam.x += e.clientX-cam.lx; cam.y += e.clientY-cam.ly; cam.lx=e.clientX; cam.ly=e.clientY; } });

    function save() {
        localStorage.setItem('save_v14', JSON.stringify({money:system.money, health:system.health, buildings:buildings}));
    }

    function animate() {
        if(!system.active) return;
        ctx.fillStyle = "#05070a"; ctx.fillRect(0,0,canvas.width, canvas.height);
        frame++;

        // --- DANS LA BOUCLE ANIMATE ---
        // 1. Gain par les maisons (Economie)
        if (frame % 60 === 0) { // Chaque seconde environ
            let income = 1; // Gain de base
            buildings.forEach(b => {
                if(b.type === 'house') income += 2; // +2$ par maison
            });
            system.money += income;
        }

        let cx = canvas.width/2 + cam.x; let cy = canvas.height/2 + cam.y;

        // B√¢timents (Style d'avant)
        buildings.forEach((b, i) => {
            ctx.fillStyle = b.type==='wall'?'#7f8c8d':(b.type==='nuke_launcher'?'#c0392b':'#2c3e50');
            ctx.fillRect(b.x+cx-20, b.y+cy-20, 40, 40);
            if(b.type === 'nuke_launcher' && frame % 150 === 0 && enemies.length > 0) enemies = [];
        });

        // ≈íufs Missiles (Cherchent les ennemis)
        units.forEach((u, i) => {
            let target = enemies[0];
            if(target) {
                let dx = target.x - u.x, dy = target.y - u.y, d = Math.sqrt(dx*dx+dy*dy);
                // √©viter la division par z√©ro
                if (d !== 0) {
                    u.x += dx/d * 5; u.y += dy/d * 5;
                }
                if(d < 20) { 
                    target.hp -= 100; 
                    u.exploded = true;
                    // 2. Gain par combat (dans la logique des ≈ìufs/nuke)
                    // Quand un ennemi meurt (hp <= 0), on ajoute :
                    if (target.hp <= 0) {
                        system.money += 10;
                    }
                    ctx.fillStyle = "yellow"; ctx.beginPath(); ctx.arc(u.x+cx, u.y+cy, 30, 0, 7); ctx.fill();
                }
            }
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.ellipse(u.x+cx, u.y+cy, 8, 10, 0, 0, 7); ctx.fill();
        });
        units = units.filter(u => !u.exploded);

        // Ennemis
        enemies.forEach(e => {
            let blocked = false;
            buildings.forEach(b => {
                let d = Math.sqrt((b.x-e.x)**2 + (b.y-e.y)**2);
                if(d < 40) { blocked = true; b.hp -= 0.5; if(b.hp <= 0) buildings = buildings.filter(x => x !== b); }
            });

            if(!blocked) {
                let dist = Math.sqrt(e.x*e.x + e.y*e.y);
                e.x -= e.x/dist * 1.2; e.y -= e.y/dist * 1.2;
                if(dist < 50) system.health -= 0.05;
            }

            ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(e.x+cx, e.y+cy, 12, 0, 7); ctx.fill();
        });

        enemies = enemies.filter(e => e.hp > 0);
        if(frame % 120 === 0) enemies.push({x: Math.random()*1000-500, y: -800, hp: 50});
        if(frame % 300 === 0) save();

        document.getElementById('m-val').innerText = Math.floor(system.money);
        document.getElementById('h-val').innerText = Math.max(0, Math.ceil(system.health));
        if(system.health <= 0) { alert("GAME OVER"); location.reload(); }
        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
